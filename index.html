<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Class Resources</title>

  <link rel="apple-touch-icon" sizes="180x180" href="./favicon_io/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon_io/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon_io/favicon-16x16.png">
  <link rel="manifest" href="favicon_io/site.webmanifest">

  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>

<header>
  <div class="container">
    <div class="header-content">
      <div class="icon-box"><i class="fa-solid fa-graduation-cap"></i></div>
      <div><h1>Class Resources</h1><p>BCA - 6th Semester</p></div>
    </div>
  </div>
</header>

<main class="container" id="main-content">
</main>

<footer>
  <div class="container footer-content">
    <p>Hosted with <i class="fa-solid fa-heart"></i> on GitHub Pages</p>
    <p class="last-updated" id="last-updated-text">
      <i class="fa-solid fa-circle-notch fa-spin"></i> Loading...
    </p>
  </div>
</footer>

<script>
  // --- CONFIGURATION ---
  // Ensure these IDs match your actual folder names
  const SECTIONS = [
    { id: 'syllabus', title: 'Syllabus', icon: 'fa-book-open' },
    { id: 'notes', title: 'Lecture Notes', icon: 'fa-note-sticky' },
    { id: 'assignments', title: 'Assignments', icon: 'fa-folder-open' }
  ];

  function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    if (['pdf'].includes(ext)) return 'fa-file-pdf';
    if (['doc', 'docx'].includes(ext)) return 'fa-file-word';
    if (['xls', 'xlsx'].includes(ext)) return 'fa-file-excel';
    if (['ppt', 'pptx'].includes(ext)) return 'fa-file-powerpoint';
    if (['zip', 'rar', '7z'].includes(ext)) return 'fa-file-zipper';
    if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'fa-file-image';
    if (['html', 'css', 'js', 'py', 'java', 'c', 'cpp'].includes(ext)) return 'fa-file-code';
    return 'fa-file';
  }

  async function init() {
    const main = document.getElementById('main-content');
    const dateEl = document.getElementById('last-updated-text');

    try {
      // Fetch the locally generated JSON
      // We add ?t=... to force the browser to ignore old cached versions
      const response = await fetch('files.json?t=' + new Date().getTime());

      if (!response.ok) throw new Error("Could not find files.json");
      const data = await response.json();

      // 1. Set Date
      if (data.metadata && data.metadata.lastUpdated) {
        dateEl.innerHTML = `<i class="fa-regular fa-clock"></i> Last Updated on: ${data.metadata.lastUpdated}`;
      } else {
        dateEl.innerHTML = "";
      }

      // 2. Build UI
      main.innerHTML = '';

      SECTIONS.forEach(section => {
        const sectionCard = document.createElement('section');
        sectionCard.className = 'category-card';

        sectionCard.innerHTML = `
          <div class="card-header">
            <div class="header-title">
              <i class="fa-solid ${section.icon}"></i> <h2>${section.title}</h2>
            </div>
            <button class="download-btn" onclick="downloadAll('${section.id}')">
              <i class="fa-solid fa-download"></i> Download All
            </button>
          </div>
        `;

        const ul = document.createElement('ul');
        ul.className = 'file-list';
        ul.id = `list-${section.id}`;

        const fileData = data[section.id] || [];

        if (fileData.length === 0) {
          ul.innerHTML = '<li class="status-msg">No files uploaded yet.</li>';
        } else {
          renderList(ul, fileData);
        }

        sectionCard.appendChild(ul);
        main.appendChild(sectionCard);

        // Save data to DOM for the download button
        ul.dataset.files = JSON.stringify(fileData);
      });

    } catch (error) {
      console.error(error);
      main.innerHTML = `<div class="loading-state" style="color:#ef4444">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <h3>Error loading files</h3>
        <p>Make sure you ran <b>generate.py</b> before uploading.</p>
      </div>`;
    }
  }

  function renderList(container, items) {
    items.forEach(item => {
      if (item.type === 'file') {
        const li = document.createElement('li');
        li.className = 'file-item';
        const icon = getFileIcon(item.name);
        li.innerHTML = `
          <a href="${item.url}" target="_blank">
            <div class="file-info"><i class="fa-regular ${icon} file-icon"></i><span>${item.name}</span></div>
            <i class="fa-solid fa-download action-icon"></i>
          </a>`;
        container.appendChild(li);
      }
      else if (item.type === 'dir') {
        const li = document.createElement('li');
        li.className = 'folder-group';

        const header = document.createElement('div');
        header.className = 'folder-header';
        header.innerHTML = `
          <div class="folder-name"><i class="fa-regular fa-folder"></i><span>${item.name}</span></div>
          <i class="fa-solid fa-chevron-right chevron"></i>`;

        header.onclick = () => li.classList.toggle('is-open');
        li.appendChild(header);

        const nestedUl = document.createElement('ul');
        nestedUl.className = 'nested-list';
        li.appendChild(nestedUl);
        container.appendChild(li);

        renderList(nestedUl, item.children);
      }
    });
  }

  // --- DOWNLOAD ZIP LOGIC ---
  async function downloadAll(sectionId) {
    const listElement = document.getElementById(`list-${sectionId}`);
    const btn = listElement.parentElement.querySelector('.download-btn');
    const originalText = btn.innerHTML;

    function flattenFiles(items) {
      let files = [];
      items.forEach(item => {
        if (item.type === 'file') files.push(item);
        if (item.type === 'dir') files = files.concat(flattenFiles(item.children));
      });
      return files;
    }

    try {
      const data = JSON.parse(listElement.dataset.files);
      const allFiles = flattenFiles(data);

      if (allFiles.length === 0) { alert("Nothing to download"); return; }

      btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Zipping...`;
      btn.disabled = true;

      const zip = new JSZip();

      const promises = allFiles.map(async (file) => {
        try {
          const response = await fetch(file.path);
          const blob = await response.blob();
          // Clean path for zip
          const zipPath = file.path.split('/').slice(1).join('/');
          zip.file(zipPath, blob);
        } catch (e) { console.error("Skip", file.name); }
      });

      await Promise.all(promises);

      const content = await zip.generateAsync({type:"blob"});
      saveAs(content, `${sectionId}.zip`);

      btn.innerHTML = `<i class="fa-solid fa-check"></i> Done`;
      setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);

    } catch (e) {
      console.error(e);
      alert("Error zipping files");
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  }

  init();
</script>
</body>
</html>