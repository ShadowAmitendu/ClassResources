<!DOCTYPE html>
<!--
  ============================================================================
  Class Resources - BCA 6th Semester
  ============================================================================

  A responsive web application for sharing and downloading class resources
  including syllabus, lecture notes, and assignments.

  Author: Amitendu Bikash Dhusiya
  Features:
    - Dynamic file listing from JSON
    - Collapsible folder navigation
    - Bulk download as ZIP
    - Mobile-responsive design

  Dependencies:
    - JSZip (for creating ZIP archives)
    - FileSaver.js (for triggering downloads)
    - Font Awesome (icons)
    - Google Fonts (Inter)
  ============================================================================
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Class Resources</title>

  <!-- Favicon Configuration - Various sizes for different devices -->
  <link rel="apple-touch-icon" sizes="180x180" href="./favicon_io/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon_io/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon_io/favicon-16x16.png">
  <link rel="manifest" href="favicon_io/site.webmanifest">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="style.css">

  <!-- Google Fonts - Preconnect for performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- ZIP Download Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>

<!-- ==================== HEADER SECTION ==================== -->
<!-- Fixed header with title and subtitle, stays visible on scroll -->
<header>
  <div class="container">
    <div class="header-content">
      <div class="icon-box"><i class="fa-solid fa-graduation-cap"></i></div>
      <div><h1>Class Resources</h1><p>BCA - 6th Semester</p></div>
    </div>
  </div>
</header>

<!-- ==================== MAIN CONTENT ==================== -->
<!-- Dynamically populated with file sections via JavaScript -->
<main class="container" id="main-content">
</main>

<!-- ==================== FOOTER SECTION ==================== -->
<!-- Fixed footer with hosting info and last updated timestamp -->
<footer>
  <div class="container footer-content">
    <p>Hosted with <i class="fa-solid fa-heart"></i> on GitHub Pages</p>
    <p class="last-updated" id="last-updated-text">
      <i class="fa-solid fa-circle-notch fa-spin"></i> Loading...
    </p>
  </div>
</footer>

<script>
  /**
   * ============================================================================
   * CONFIGURATION
   * ============================================================================
   * Define the sections to display on the page.
   * Each section corresponds to a folder in the project root.
   *
   * @property {string} id    - Folder name (must match actual folder name)
   * @property {string} title - Display title shown in the UI
   * @property {string} icon  - Font Awesome icon class (without 'fa-solid' prefix)
   */
  const SECTIONS = [
    { id: 'syllabus', title: 'Syllabus', icon: 'fa-book-open' },
    { id: 'notes', title: 'Lecture Notes', icon: 'fa-note-sticky' },
    { id: 'assignments', title: 'Assignments', icon: 'fa-folder-open' }
  ];

  /**
   * Returns the appropriate Font Awesome icon class based on file extension.
   * Used to display visual indicators for different file types.
   *
   * @param {string} filename - The name of the file including extension
   * @returns {string} Font Awesome icon class (e.g., 'fa-file-pdf')
   *
   * @example
   * getFileIcon('document.pdf')  // Returns 'fa-file-pdf'
   * getFileIcon('notes.docx')    // Returns 'fa-file-word'
   */
  function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    if (['pdf'].includes(ext)) return 'fa-file-pdf';
    if (['doc', 'docx'].includes(ext)) return 'fa-file-word';
    if (['xls', 'xlsx'].includes(ext)) return 'fa-file-excel';
    if (['ppt', 'pptx'].includes(ext)) return 'fa-file-powerpoint';
    if (['zip', 'rar', '7z'].includes(ext)) return 'fa-file-zipper';
    if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'fa-file-image';
    if (['html', 'css', 'js', 'py', 'java', 'c', 'cpp'].includes(ext)) return 'fa-file-code';
    return 'fa-file';
  }

  /**
   * ============================================================================
   * INITIALIZATION
   * ============================================================================
   * Main initialization function that runs on page load.
   * Fetches file data from files.json and builds the entire UI.
   *
   * Flow:
   * 1. Fetch files.json (generated by generate.py)
   * 2. Update the "Last Updated" timestamp
   * 3. Create section cards for each configured section
   * 4. Render file lists within each section
   *
   * @async
   * @throws {Error} If files.json cannot be loaded
   */
  async function init() {
    const main = document.getElementById('main-content');
    const dateEl = document.getElementById('last-updated-text');

    /**
     * Displays an error message in the main content area.
     * @param {string} message - Error message to display
     */
    function showError(message) {
      console.error(message);
      main.innerHTML = `<div class="loading-state" style="color:#ef4444">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <h3>Error loading files</h3>
        <p>Make sure you ran <b>generate.py</b> before uploading.</p>
      </div>`;
    }

    try {
      // Fetch the locally generated JSON
      // Cache-busting query param (?t=...) forces browser to fetch fresh data
      const response = await fetch('files.json?t=' + new Date().getTime());

      // Handle fetch failure
      if (!response.ok) {
        showError("Could not find files.json");
        return;
      }

      const data = await response.json();

      // Step 1: Update the "Last Updated" timestamp in footer
      if (data.metadata && data.metadata.lastUpdated) {
        dateEl.innerHTML = `<i class="fa-regular fa-clock"></i> Last Updated on: ${data.metadata.lastUpdated}`;
      } else {
        dateEl.innerHTML = "";
      }

      // Step 2: Build UI - Create section cards for each category
      main.innerHTML = '';

      SECTIONS.forEach(section => {
        // Create the main section card container
        const sectionCard = document.createElement('section');
        sectionCard.className = 'category-card';

        // Add card header with title and download button
        sectionCard.innerHTML = `
          <div class="card-header">
            <div class="header-title">
              <i class="fa-solid ${section.icon}"></i> <h2>${section.title}</h2>
            </div>
            <button class="download-btn" onclick="downloadAll('${section.id}')">
              <i class="fa-solid fa-download"></i> Download All
            </button>
          </div>
        `;

        // Create the file list container
        const ul = document.createElement('ul');
        ul.className = 'file-list';
        ul.id = `list-${section.id}`;

        const fileData = data[section.id] || [];

        // Render files or show empty state message
        if (fileData.length === 0) {
          ul.innerHTML = '<li class="status-msg">No files uploaded yet.</li>';
        } else {
          renderList(ul, fileData);
        }

        sectionCard.appendChild(ul);
        main.appendChild(sectionCard);

        // Store file data in DOM element for download functionality
        ul.dataset.files = JSON.stringify(fileData);
      });

    } catch (error) {
      // Display error state if files.json cannot be loaded
      showError(error.message || "Unknown error occurred");
    }
  }

  /**
   * ============================================================================
   * FILE LIST RENDERING
   * ============================================================================
   * Recursively renders a list of files and directories into the DOM.
   * Handles both files (as download links) and directories (as collapsible groups).
   *
   * @param {HTMLElement} container - The UL element to append items to
   * @param {Array} items - Array of file/directory objects from files.json
   *
   * @example
   * // items structure:
   * [
   *   { type: 'file', name: 'doc.pdf', url: 'path/doc.pdf' },
   *   { type: 'dir', name: 'Folder', children: [...] }
   * ]
   */
  function renderList(container, items) {
    items.forEach(item => {
      if (item.type === 'file') {
        // ===== RENDER FILE ITEM =====
        const li = document.createElement('li');
        li.className = 'file-item';
        const icon = getFileIcon(item.name);

        // File item with clickable link and download icon
        li.innerHTML = `
          <a href="${item.url}" target="_blank">
            <div class="file-info"><i class="fa-regular ${icon} file-icon"></i><span>${item.name}</span></div>
            <i class="fa-solid fa-download action-icon"></i>
          </a>`;
        container.appendChild(li);
      }
      else if (item.type === 'dir') {
        // ===== RENDER FOLDER (COLLAPSIBLE GROUP) =====
        const li = document.createElement('li');
        li.className = 'folder-group';

        // Folder header with name and chevron toggle icon
        const header = document.createElement('div');
        header.className = 'folder-header';
        header.innerHTML = `
          <div class="folder-name"><i class="fa-regular fa-folder folder-icon"></i><span>${item.name}</span></div>
          <i class="fa-solid fa-chevron-down chevron"></i>`;

        // Toggle open/close state on click
        header.onclick = () => li.classList.toggle('is-open');
        li.appendChild(header);

        // Nested list for folder contents
        const nestedUl = document.createElement('ul');
        nestedUl.className = 'nested-list';
        li.appendChild(nestedUl);
        container.appendChild(li);

        // Recursively render children (files and subfolders)
        renderList(nestedUl, item.children);
      }
    });
  }

  /**
   * ============================================================================
   * BULK DOWNLOAD FUNCTIONALITY
   * ============================================================================
   * Downloads all files in a section as a single ZIP archive.
   * Uses JSZip library for compression and FileSaver.js for triggering download.
   *
   * @async
   * @param {string} sectionId - The ID of the section to download (e.g., 'syllabus')
   *
   * @example
   * downloadAll('assignments')  // Downloads all assignment files as assignments.zip
   */
  async function downloadAll(sectionId) {
    const listElement = document.getElementById(`list-${sectionId}`);
    const btn = listElement.parentElement.querySelector('.download-btn');
    const originalText = btn.innerHTML;

    /**
     * Recursively flattens nested file structure into a single array.
     * Extracts only file objects, ignoring directory containers.
     *
     * @param {Array} items - Nested array of files and directories
     * @returns {Array} Flat array containing only file objects
     */
    function flattenFiles(items) {
      let files = [];
      items.forEach(item => {
        if (item.type === 'file') files.push(item);
        if (item.type === 'dir') files = files.concat(flattenFiles(item.children));
      });
      return files;
    }

    try {
      // Parse file data stored in DOM element
      const data = JSON.parse(listElement.dataset.files);
      const allFiles = flattenFiles(data);

      // Check if there are files to download
      if (allFiles.length === 0) {
        alert("Nothing to download");
        return;
      }

      // Update button to show loading state
      btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Zipping...`;
      btn.disabled = true;

      // Create new ZIP archive
      const zip = new JSZip();

      // Fetch all files in parallel and add to ZIP
      const promises = allFiles.map(async (file) => {
        try {
          const response = await fetch(file.path);
          const blob = await response.blob();

          // Clean path for ZIP structure (remove root folder prefix)
          const zipPath = file.path.split('/').slice(1).join('/');
          zip.file(zipPath, blob);
        } catch (e) {
          console.error("Failed to fetch, skipping:", file.name);
        }
      });

      await Promise.all(promises);

      // Generate ZIP blob and trigger download
      const content = await zip.generateAsync({type:"blob"});
      saveAs(content, `${sectionId}.zip`);

      // Show success state and reset button after delay
      btn.innerHTML = `<i class="fa-solid fa-check"></i> Done`;
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }, 2000);

    } catch (e) {
      // Handle errors and reset button
      console.error(e);
      alert("Error zipping files");
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  }

  // ============================================================================
  // APPLICATION ENTRY POINT
  // ============================================================================
  // Initialize the application when the script loads
  init();
</script>
</body>
</html>